Avremo un client C1 che naviga in rete "ignaro" di quanto stiamo per fare.
C2 opera da collettore per le statistiche netflow esportate dalla middlebox che utilizziamo,
funziona sia con uno switch che con un router virtuale.

Configurazione di rete
 ________________________________
|                    (bridge)   _|
|  C1----(lab)----R------------|_|<-NIC
|                               ||
|              C2---------------||
|_Host OS________________________|

///////////////////////////////////////////////////////////////////////////////
    CONFIG MIDDLEBOX
///////////////////////////////////////////////////////////////////////////////

Si installa il pacchetto iptables-netflow-dkms con il comando:
    
    sudo apt install iptables-netflow-dkms

netflow dkms serve a generare le statische netflow, si carica con il comando:

    sudo modprobe ipt_NETFLOW destination=127.0.0.1:2055

il comando, oltre a caricare il modulo, serve a specificare quale sia il collettore che riceverà i dati netflow, 
l'IP qua è il loopback perchè sarà lo switch stesso a fare da collettore(o lo switch o il pc che fa da host system, uno dei due), la porta da usare è il 2055

See, you may add options in insmod/modprobe command line, or add them in /etc/modprobe.conf or /etc/modprobe.d/ipt_NETFLOW.conf like thus:

    options ipt_NETFLOW destination=127.0.0.1:2055 protocol=9 natevents=1

Dalla pagina GitHub di ipt-netflow https://github.com/aabc/ipt-netflow

Dato che intendiamo utilizzare un Collettore ESTERNO, va specificato l'indirizzo IP del collettore

Per inviare traffico al collettore Netflow devo creare regole specifiche:
	
    iptables -I FORWARD -j NETFLOW
    iptables -I INPUT -j NETFLOW
    iptables -I OUTPUT -j NETFLOW

è importante mettere queste regole in cima alle catene per far si che i pacchetti sono siano intercettati da regole precedenti, specificando che
si vuol mettere la regola in posizione 1 come segue:

    iptables -I FORWARD 1 -j NETFLOW

Qui finisce la configurazione della middlebox, se voglio vedere i flussi netflow dalla middle uso il comando:
    sudo cat /proc/net/stat/ipt_netflow_flows

///////////////////////////////////////////////////////////////////////////////
    CONFIG COLLETTORE
///////////////////////////////////////////////////////////////////////////////

installare il pacchetto net-tools, tramite il comando: 
    sudo netstat -n --udp --listen 

Verifico se il collettore è in ascolto, devo capire se la porta 2055 che intendo utilizzare per l'esportazione del traffico è disponibile

A questo punto dovrebbe essere tutto collegato, la middlebox esporta le statistiche netflow e il collettore le elabora
Per vedere cosa arriva al collettore si vanno a vedere alcuni file:
    cd /var/cache/nfdump/
    ls 

si dovrebbero vedere dei file del tipo nfcapd.<timestamp>
Utilizziamo dei comandi ricorsivi del tipo: 
    nfdump -R /var/cache/nfdump/
che guadando tutto dentro alla directory

Si possono specificare alcune flag per il filtraggio, ad esempio:
    -A aggrega i dati
    -O ordina i dati in base a quello che specifichiamo, -O start ordina i flussi in base all'indirizzo

oppure posso specificare condizioni come: 
    'proto tcp and dst port 443'
    -A srcip 'host 8.8.8.8'

Se voglio salvare in un file i vari filtraggi che vado a definire devo aggiungere alla fine dei comandi visti sopra: 
    >> /home/studente/file.txt


///////////////////////////////////////////////////////////////////////////////
    APPUNTI DEL PROFESSORE
///////////////////////////////////////////////////////////////////////////////

Per installare il modulo di iptables che permette di esportare le statistiche del traffico in formato NetFlow è consigliabile prima aggiornare l’elenco dei package:

    sudo apt update

poi istallare il modulo vero e proprio con il comando:

    sudo apt install iptables-netflow-dkms

Questo comando istalla un modulo del kernel, ipt_NETFLOW, che poi va caricato manualmente tramite il comando

    sudo modprobe ipt_NETFLOW destination=<IP>:<porta>

dove <IP> rappresenta l’indirizzo IP del collettore di statistiche e <porta> la porta di strato 4 su cui il collettore è in ascolto. La configurazione di default prevede l’uso della porta 2055. La versione di NetFlow utilizzata è la v5. Per cambiare versione o aggiungere altre opzioni, tipo l’esportazione orientata ai nodi che agiscono da NAT, si può usare la versione v9 o ipfix:

    sudo modprobe ipt_NETFLOW destination=<IP>:<porta> protocol=9 natevents=1

Per configurazioni più avanzate, una trattazione dettagliata è disponibile alla pagina https://github.com/aabc/ipt-netflow.

Una volta che il modulo del kernel è stato caricato, è necessario usare iptables per indicare di quale traffico si vogliono esportare le statistiche. Per far questo è necessaria una regola della tabella mangle. Ad esempio, se si vuole tracciare tutto il traffico che attraversa il nodo che risponde ai criteri elencati in <matching-criteria>, il comando da dare è il seguente

    sudo iptables -I FORWARD <matching-criteria> -j NETFLOW

Si consiglia di mettere tale regola al primo posto (-I FORWARD) in modo tale da intercettare tutto il traffico, anche quello che poi potrà subire modifiche a causa di altre regole seguenti.

Le statistiche di utilizzo di NetFlow sono disponibili nel file:

    /proc/net/stat/ipt_netflow

mentre le statistiche relative ai flussi sono disponibili nel file:

    /proc/net/stat/ipt_netflow_flows

Tali file possono essere facilmente ispezionati con il comando

    cat <nome-file>

Per istallare il collettore delle statistiche, prima di tutto è necessario scegliere il nodo. Può essere lo stesso nodo oppure può essere un nodo esterno, anche remoto. Sul nodo scelto, aggiornare prima la lista dei package e poi installare il pacchetto nfdump

    sudo apt install nfdump

Il pacchetto nfdump contiene 2 moduli, nfcapd, che è il vero e proprio collettore, e nfdump.

Il collettore nfcapd ascolta di default sulla porta 2055. Si può verificare che effettivamente la porta è aperta attraverso netstat o nmap:

    netstat -n –udp --listen

Per configurare il servizio in modo diverso, è possibile editare il file

    /lib/systemd/system/nfdump.service

Prima però è necessario abilitare il servizio e stopparlo:

    sudo systemctl enable nfdump.service

    sudo systemctl stop nfdump.service

Una volta fatte le modifiche, è possibile riavviare il demone del servizio

    sudo systemctl daemon-reload

    sudo systemctl start nfdump.service

I dati ricevuti sono disponibili in formato binario nella cartella /var/cache/nfdump.

È possibile consultare i log in /var/log/syslog

    tail -100 /var/log/syslog |grep nfcapd

Per ispezionare i dati relativi ai flussi in formato non binario, è necessario usare nfdump:

    nfdump -R /var/cache/nfdump

Per ordine in base al tempo di inizio del flusso:

    -O start

Aggregare i flussi in modo bidirezionale:

    -B

Scrivere l’output su un file csv per esportare i dati

    -o csv

Per ispezionare un file specifico

    nfdump -r /var/cache/nfdump/nfcapd.<stringa-data>

L’opzione -I permette di avere delle statistiche cumulative e non per flusso

    nfdump -I -r /var/cache/nfdump/nfcapd.<stringa-data>

Con l’opzione -R + nome file si vedono tutti i file a partire da quello indicato tranne quello che viene scritto al momento (nfcapd.current.<number>)

    nfdump -R /var/cache/nfdump/nfcapd.<stringa-data>

E’ possibile usare filtri stile tcpdump per fare analisi del traffico più mirata tra apici singoli (‘ filtro ‘)

    nfdump -r /var/cache/nfdump/nfcapd.<stringa-data>  ‘host 6.6.6.6 and proto tcp and dst port 443’

Con l’opzione -o extended è possibile aggiungere colonne con statistiche relative ai bps, con -n x è possibile visualizzare i top x secondo la metrica specificata da -O (ad esempio bps o bytes o bpp)

    nfdump -r /var/cache/nfdump/nfcapd.<stringa-data> -n 10 -O bps -o extended

L’opzione -A permette di aggregare i flussi su base filtro

    nfdump -r /var/cache/nfdump/nfcapd.<stringa-data> -A srcip ‘host 8.8.4.4’ #aggrega per indirizzi ip, fa vedere i flussi in entrambe le direzioni

Per visualizzare le statistiche relative ai flussi che utilizzano la porta 443 relative sia a bps sia per indirizzo mittente sia per indirizzo destinatario si può usare il comando

    nfdump -r /var/cache/nfdump/nfcapd.<stringa-data> -s srcip/bps -s dstip/bps ‘port 443’

Per anonimizzare il traffic prima dell’esportazione, generare una chiave da 32 caratteri ed usare il comando

    nfanon -K <chiave> -r /var/cache/nfdump/nfcapd.<stringa-data>

Per filtrare in base alla fascia oraria usar e l’opzione -t

    nfdump -r /var/cache/nfdump/nfcapd.<stringa-data> -t <tempo-inizio>-<tempo-fine> ‘ filtro ‘

dove <tempo-inizio> è del tipo 2022/10/27/08:43:21